<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Pedido - Diagn√≥stico</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .test-box {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #0056b3;
        }

        #resultado {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <h1>üîß Test de Pedidos - Diagn√≥stico</h1>

    <div class="test-box">
        <h2>Paso 1: Verificar Conexi√≥n al Servidor</h2>
        <p>Este test enviar√° un pedido de prueba directamente a <code>procesar_pedido_directo.php</code></p>
        <button onclick="testPedido()">üöÄ Enviar Pedido de Prueba</button>
    </div>

    <div class="test-box">
        <h2>Resultado:</h2>
        <div id="resultado" class="loading">Esperando... Haz clic en el bot√≥n para iniciar el test.</div>
    </div>

    <div class="test-box">
        <h2>Paso 2: Ver Logs</h2>
        <p>
            <a href="debug_pedidos.php" target="_blank">üìã Ver Logs de Debug</a>
        </p>
    </div>

    <div class="test-box">
        <h2>Paso 3: Test PHP Directo</h2>
        <p>
            <a href="test_pedido_servidor.php" target="_blank">üî¨ Test desde PHP (sin JavaScript)</a>
        </p>
    </div>

    <script>
        async function testPedido() {
            const resultado = document.getElementById('resultado');
            resultado.className = 'loading';
            resultado.textContent = '‚è≥ Enviando pedido de prueba...';

            const pedido = {
                tipo_pedido: 'delivery',
                cliente: {
                    nombre: 'Test Usuario',
                    telefono: '999888777',
                    direccion: 'Av. Test 123',
                    mesa: null,
                    email: null
                },
                productos: [
                    {
                        id: 1,  // Cambia este ID si no existe en tu BD
                        nombre: 'Producto Test',
                        precio: 25.00,
                        cantidad: 2,
                        observaciones: null
                    }
                ],
                metodo_pago: 'efectivo',
                observaciones: 'Test desde HTML',
                subtotal: 50.00,
                descuento: 0,
                costo_delivery: 5.00,
                total: 55.00
            };

            console.log('=== ENVIANDO PEDIDO ===');
            console.log('URL:', 'Vista/procesar_pedido_directo.php');
            console.log('Datos:', pedido);

            try {
                const response = await fetch('Vista/procesar_pedido_directo.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(pedido)
                });

                console.log('Response Status:', response.status);
                console.log('Response OK:', response.ok);

                const responseText = await response.text();
                console.log('Response Text:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('Response Data:', data);
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    resultado.className = 'error';
                    resultado.textContent = '‚ùå ERROR: El servidor no devolvi√≥ JSON v√°lido\n\n' +
                        'Respuesta recibida:\n' + responseText.substring(0, 500);
                    return;
                }

                if (data.success) {
                    resultado.className = 'success';
                    resultado.textContent = '‚úÖ √âXITO!\n\n' +
                        'N√∫mero de pedido: ' + (data.nro_pedido || 'N/A') + '\n' +
                        'ID: ' + (data.id_pedido || 'N/A') + '\n' +
                        'Total: S/ ' + (data.total || 0) + '\n' +
                        'Mensaje: ' + (data.mensaje || 'Pedido creado') + '\n\n' +
                        'JSON completo:\n' + JSON.stringify(data, null, 2);
                } else {
                    resultado.className = 'error';
                    resultado.textContent = '‚ùå ERROR\n\n' +
                        'Mensaje: ' + (data.error || data.mensaje || 'Error desconocido') + '\n\n' +
                        'JSON completo:\n' + JSON.stringify(data, null, 2);
                }

            } catch (error) {
                console.error('Error completo:', error);
                resultado.className = 'error';
                resultado.textContent = '‚ùå FAILED TO FETCH\n\n' +
                    'Error: ' + error.message + '\n\n' +
                    'Posibles causas:\n' +
                    '1. El servidor PHP no est√° corriendo (XAMPP Apache apagado)\n' +
                    '2. La ruta al archivo es incorrecta\n' +
                    '3. Hay un error de sintaxis en procesar_pedido_directo.php\n' +
                    '4. Problema de CORS o permisos\n\n' +
                    'Revisa la consola del navegador (F12) para m√°s detalles.';
            }
        }

        // Auto-ejecutar al cargar (opcional)
        // testPedido();
    </script>
</body>

</html>